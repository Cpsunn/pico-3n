name: Build UF2

on:
  workflow_dispatch: {}
  workflow_call:

jobs:
  build-uf2:
    name: Build UF2 on Ubuntu
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git pkg-config libusb-1.0-0-dev gcc-arm-none-eabi libnewlib-arm-none-eabi

    - name: Check environment
      run: |
        echo "=== Environment Check ==="
        which arm-none-eabi-gcc && arm-none-eabi-gcc --version
        cmake --version
        ls -la pico-sdk || echo "pico-sdk not found in workspace"

    - name: Clone pico-sdk
      run: |
        if [ ! -d pico-sdk ]; then
          echo "Cloning pico-sdk..."
          git clone --depth 1 https://github.com/raspberrypi/pico-sdk.git pico-sdk
        fi
        cd pico-sdk
        git submodule update --init --recursive --depth 1 || true

    - name: Set PICO_SDK_PATH
      run: |
        echo "PICO_SDK_PATH=$(pwd)/pico-sdk" >> $GITHUB_ENV
        echo "PICO_SDK_PATH is now: $(pwd)/pico-sdk"

    - name: Create and configure build directory
      run: |
        mkdir -p build
        cd build
        echo "=== Configuring CMake ==="
        echo "PICO_SDK_PATH is: $PICO_SDK_PATH"
        ls -la "$PICO_SDK_PATH" || echo "PICO_SDK_PATH not accessible!"
        cmake .. \
          -DPICO_SDK_PATH="${PICO_SDK_PATH}" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DCMAKE_MESSAGE_LOG_LEVEL=VERBOSE
        echo "=== CMake Configuration Complete ==="

    - name: Build
      run: |
        cd build
        echo "=== Starting Build ==="
        make VERBOSE=1 2>&1 | tee build.log || {
          echo ""
          echo "=== Build Failed - Last 150 lines of output ==="
          tail -150 build.log
          echo ""
          echo "=== Searching for undefined reference errors ==="
          grep -i "undefined reference\|error:" build.log | head -30 || true
          exit 1
        }
        echo "=== Build Successful ==="
        
    - name: Generate UF2
      if: success()
      run: |
        cd build
        echo "=== Ensuring UF2/BIN artifacts exist ==="
        ELF_FILE=./pico_fx3u_simulator.elf
        UF2_FILE=./pico_fx3u_simulator.uf2
        if [ ! -f "$ELF_FILE" ]; then
          echo "ERROR: Expected ELF file ${ELF_FILE} not found"
          ls -lh
          exit 1
        fi
        if [ ! -f "$UF2_FILE" ]; then
          echo "UF2 missing, attempting to build elf2uf2 tool..."
          ELF2UF2_BIN=$(command -v elf2uf2 || true)
          if [ -z "$ELF2UF2_BIN" ] && [ -d "_deps/picotool-build" ]; then
            cmake --build _deps/picotool-build --target elf2uf2
            ELF2UF2_BIN=$(find _deps/picotool-build -name elf2uf2 -type f -executable | head -n 1)
          fi
          if [ -z "$ELF2UF2_BIN" ] && [ -d "$PICO_SDK_PATH" ]; then
            ELF2UF2_BIN=$(find "$PICO_SDK_PATH" -name elf2uf2 -type f -executable | head -n 1)
          fi
          if [ -z "$ELF2UF2_BIN" ]; then
            echo "ERROR: Unable to locate elf2uf2 tool to generate UF2."
            ls -lh
            exit 1
          fi
          echo "Using elf2uf2 at ${ELF2UF2_BIN}"
          "$ELF2UF2_BIN" "$ELF_FILE" "$UF2_FILE"
        fi
        if [ ! -f pico_fx3u_simulator.bin ]; then
          echo "Generating BIN image via objcopy..."
          arm-none-eabi-objcopy -O binary "$ELF_FILE" pico_fx3u_simulator.bin
        fi

        mkdir -p ../artifacts
        cp "$UF2_FILE" ../artifacts/pico_fx3u_simulator.uf2
        cp "$ELF_FILE" ../artifacts/pico_fx3u_simulator.elf
        [ -f pico_fx3u_simulator.bin ] && cp pico_fx3u_simulator.bin ../artifacts/
        [ -f pico_fx3u_simulator.hex ] && cp pico_fx3u_simulator.hex ../artifacts/
        # List all generated files
        echo ""
        echo "Files in build directory:"
        ls -lh pico_fx3u_simulator.* || echo "No pico_fx3u_simulator files found"

    - name: List build output
      if: always()
      run: |
        echo "=== Current Working Directory ==="
        pwd
        echo ""
        echo "=== Complete Recursion of Build Directory ==="
        find build -type f 2>/dev/null | sort || echo "Build directory not found"
        echo ""
        echo "=== File Details ==="
        find build -type f -exec file {} \; 2>/dev/null | head -50 || true
        echo ""
        echo "=== Check for UF2/ELF/BIN Files Explicitly ==="
        find . \( -name "*.uf2" -o -name "*.elf" -o -name "*.bin" \) -type f 2>/dev/null | sort || echo "No UF2/ELF/BIN files found in entire workspace"

    - name: Upload UF2 artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: |
          artifacts/pico_fx3u_simulator.uf2
          artifacts/pico_fx3u_simulator.elf
          artifacts/pico_fx3u_simulator.bin
          artifacts/pico_fx3u_simulator.hex
        if-no-files-found: warn
        retention-days: 30

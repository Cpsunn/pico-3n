name: Build UF2

on:
  workflow_dispatch: {}
  push:
    branches: [ main, master ]

jobs:
  build-uf2:
    name: Build UF2 on Ubuntu
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git pkg-config libusb-1.0-0-dev gcc-arm-none-eabi libnewlib-arm-none-eabi

    - name: Check environment
      run: |
        echo "=== Environment Check ==="
        which arm-none-eabi-gcc && arm-none-eabi-gcc --version
        cmake --version
        ls -la pico-sdk || echo "pico-sdk not found in workspace"

    - name: Clone pico-sdk
      run: |
        if [ ! -d pico-sdk ]; then
          echo "Cloning pico-sdk..."
          git clone --depth 1 https://github.com/raspberrypi/pico-sdk.git pico-sdk
        fi
        cd pico-sdk
        git submodule update --init --recursive --depth 1 || true

    - name: Set PICO_SDK_PATH
      run: |
        echo "PICO_SDK_PATH=$(pwd)/pico-sdk" >> $GITHUB_ENV
        echo "PICO_SDK_PATH is now: $(pwd)/pico-sdk"

    - name: Create and configure build directory
      run: |
        mkdir -p build
        cd build
        echo "=== Configuring CMake ==="
        echo "PICO_SDK_PATH is: $PICO_SDK_PATH"
        ls -la "$PICO_SDK_PATH" || echo "PICO_SDK_PATH not accessible!"
        cmake .. \
          -DPICO_SDK_PATH="${PICO_SDK_PATH}" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_VERBOSE_MAKEFILE=ON \
          -DCMAKE_MESSAGE_LOG_LEVEL=VERBOSE
        echo "=== CMake Configuration Complete ==="

    - name: Build
      run: |
        cd build
        echo "=== Starting Build ==="
        make VERBOSE=1 2>&1 | tee build.log || {
          echo ""
          echo "=== Build Failed - Last 150 lines of output ==="
          tail -150 build.log
          echo ""
          echo "=== Searching for undefined reference errors ==="
          grep -i "undefined reference\|error:" build.log | head -30 || true
          exit 1
        }
        echo "=== Build Successful ==="

    - name: List build output
      if: always()
      run: |
        echo "=== Build Directory Contents ==="
        ls -la build/ || true
        echo "=== Searching for UF2 files ==="
        find . -type f -name "*.uf2" -exec ls -lh {} \; || true
        echo "=== Searching for ELF files ==="
        find . -type f -name "*.elf" -exec ls -lh {} \; || true

    - name: Upload UF2 artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: uf2-artifacts
        path: build/**/*.uf2
        if-no-files-found: warn
